# E2E Testing Infrastructure

This directory contains end-to-end tests for go4dot, including visual TUI testing using VHS and programmatic TUI testing using teatest.

## Three-Tier Testing Strategy

```
+-------------------------------------------------------------+
|                    VHS Visual Tests                          |
|  - Full user flows (onboarding, install, navigation)         |
|  - Screenshot regression testing                             |
|  - Multimodal review by Claude                               |
+-------------------------------------------------------------+
                              ^
+-------------------------------------------------------------+
|                  Teatest E2E Tests                           |
|  - Key sequences and navigation                              |
|  - Text appearance assertions                                |
|  - NO custom messages (use unit tests instead)               |
+-------------------------------------------------------------+
                              ^
+-------------------------------------------------------------+
|                     Unit Tests                               |
|  - Message handling (call Update() directly)                 |
|  - State transitions                                         |
|  - Panel logic                                               |
+-------------------------------------------------------------+
```

### When to Use Each Test Type

| Test Type | Use When | Example |
|-----------|----------|---------|
| **Unit** | Testing message handling, state changes | `TestPostOnboarding_AcceptInstall_PanelsHaveDimensions` |
| **Teatest** | Testing key inputs, navigation, text rendering | `TestDashboard_Navigation`, `TestOnboarding_StartsFromNoConfigView` |
| **VHS** | Visual regression, full flows, multimodal review | `dashboard_startup.tape`, `dashboard_navigation.tape` |

### Critical: Teatest Limitations

**DO NOT use `tm.Send()` for custom messages in teatest E2E tests.**

Custom messages (like `OnboardingCompleteMsg`) don't work reliably in teatest because:
- Teatest routes messages through a channel
- Custom messages don't match Bubble Tea's internal message loop

For testing custom message handling, use unit tests that call `Update()` directly:
- See `internal/ui/dashboard/dashboard_test.go`
- `TestPostOnboarding_AcceptInstall_PanelsHaveDimensions`
- `TestPostOnboarding_DeclineInstall_PanelsHaveDimensions`

## Directory Structure

```text
test/e2e/
├── helpers/               # Testing utilities
│   ├── docker.go         # Docker container helpers for isolated testing
│   ├── teatest_extended.go  # Extended teatest helpers
│   └── vhs.go            # VHS wrapper for running tapes
├── scenarios/            # E2E test scenarios
│   ├── cli_test.go       # CLI output tests (VHS)
│   ├── dashboard_tui_test.go  # Dashboard teatest tests
│   ├── onboarding_test.go     # Onboarding teatest tests
│   └── vhs_visual_test.go     # Visual regression tests (VHS)
├── tapes/                # VHS tape files (test scripts)
│   ├── cli_help.tape
│   ├── dashboard_startup.tape
│   ├── dashboard_navigation.tape
│   ├── health_panel.tape
│   └── filter_selection.tape
├── golden/               # Golden files (expected outputs)
│   └── cli_help.txt
├── outputs/              # Temporary test outputs (gitignored)
├── screenshots/          # Visual outputs (generated by tests)
├── fixtures/             # Test data and configurations
│   └── dotfiles/        # Minimal test dotfiles repo
└── README.md            # This file
```

## TDD Workflow

### RED: Write Failing Test

```bash
# For message handling (use unit test)
vim internal/ui/dashboard/dashboard_test.go
go test -v -run TestNewFeature ./internal/ui/dashboard/...
# Expected: FAIL

# For key-based interactions (use teatest)
vim test/e2e/scenarios/feature_test.go
go test -v -tags=e2e -run TestNewFeature ./test/e2e/scenarios/...
# Expected: FAIL
```

### GREEN: Implement Fix

```bash
vim internal/ui/dashboard/dashboard.go
go test -v -run TestNewFeature ./internal/ui/dashboard/...
# Expected: PASS
```

### REFACTOR: Clean Up + Visual Verify

```bash
make lint
make e2e-visual  # Review screenshots
```

### Visual Verification with Claude

After making visual changes:
1. Run `make e2e-visual` to generate screenshots
2. Ask Claude to read `test/e2e/screenshots/<name>.png`
3. Claude uses multimodal to verify the UI looks correct
4. If good, commit. If not, iterate.

## Running Tests

### Unit Tests (Fast)
```bash
go test ./internal/ui/dashboard/...
```

### Teatest E2E Tests (Key-based)
```bash
go test -v -tags=e2e ./test/e2e/scenarios/...
```

### VHS Visual Tests (Docker-based)
```bash
# Run all visual tests
make e2e-visual

# Update golden files after intentional changes
make e2e-visual-update
# Or: UPDATE_GOLDEN=1 go test -v -tags=e2e ./test/e2e/scenarios/...

# Clean test outputs
make e2e-clean
```

### Full Validation
```bash
make validate        # Full validation (build, lint, test, e2e, visual)
make validate-quick  # Skip visual tests
```

## Writing Tests

### Unit Tests (Message Handling)

Test custom messages by calling `Update()` directly:

```go
func TestMyFeature_MessageHandling(t *testing.T) {
    m := New(state)
    m.width = 100
    m.height = 40

    // Send the custom message directly
    updatedModel, _ := m.Update(MyCustomMsg{Data: "test"})
    model := updatedModel.(*Model)

    // Assert state changes
    if model.someField != expectedValue {
        t.Errorf("expected %v, got %v", expectedValue, model.someField)
    }
}
```

### Teatest E2E Tests (Key Inputs)

Test key-based interactions using the extended helpers:

```go
//go:build e2e

func TestDashboard_KeyNavigation(t *testing.T) {
    state := dashboard.State{
        Platform:  &platform.Platform{OS: "linux"},
        Configs:   []config.ConfigItem{{Name: "vim"}},
        HasConfig: true,
    }

    model := dashboard.New(state)
    tm := helpers.NewTUITestModel(t, &model, teatest.WithInitialTermSize(100, 40))

    // Wait for render
    tm.WaitForText("vim", 2*time.Second)

    // Navigate using keys
    helpers.NewKeySequence().
        Down().          // Move selection
        Space().         // Select
        Tab().           // Switch panel
        Esc().           // Quit
        SendTo(tm)

    tm.WaitFinished(2 * time.Second)
}
```

### VHS Visual Tests (Screenshots)

Create a VHS tape and corresponding test:

**Tape file (`test/e2e/tapes/my_feature.tape`):**
```tape
Set Shell bash
Set FontSize 14
Set Width 120
Set Height 40

# Isolate environment
Set Env HOME /tmp/g4d-e2e-test
Set Env XDG_CONFIG_HOME /tmp/g4d-e2e-test/.config

# Run in fixtures (container paths)
Type "cd ~/fixtures && g4d"
Enter
Sleep 2s

# Take screenshot
Screenshot test/e2e/screenshots/my_feature.png

# Quit
Type "q"
Sleep 500ms

# Output for golden comparison
Output test/e2e/outputs/my_feature.txt
```

**Test file (`test/e2e/scenarios/vhs_visual_test.go`):**
```go
func TestVHS_MyFeature(t *testing.T) {
    runVHSTest(t, vhsTestCase{
        name:       "my feature",
        tapePath:   "test/e2e/tapes/my_feature.tape",
        outputPath: "test/e2e/outputs/my_feature.txt",
        goldenPath: "test/e2e/golden/my_feature.txt",
    })
}
```

## VHS Commands Reference

### Terminal Setup
- `Set Shell <shell>` - Set shell (bash, zsh, fish)
- `Set Width <pixels>` - Set terminal width
- `Set Height <pixels>` - Set terminal height
- `Set FontSize <size>` - Set font size

### Input
- `Type "text"` - Type text (without pressing Enter)
- `Enter` - Press Enter key
- `Escape` - Press Escape key
- `Tab` - Press Tab key
- `Space` - Press Space key
- `Up/Down/Left/Right` - Arrow keys
- `Ctrl+C` - Send Ctrl+C
- `Backspace` - Press backspace

### Output
- `Output <path>` - Save terminal output to file
- `Screenshot <path>` - Take screenshot

### Timing
- `Sleep <duration>` - Wait (e.g., `500ms`, `2s`)

### Environment
- `Set Env <VAR> <value>` - Set environment variable

## Docker Container Setup

VHS tests run inside Docker containers for complete isolation. The container:
- Has g4d binary at `/usr/local/bin/g4d`
- Has test fixtures at `/home/testuser/fixtures`
- Has VHS, ttyd, and chromium installed
- Runs as non-root `testuser`

Tapes are automatically modified:
- `./bin/g4d` becomes `g4d`
- Output paths are adjusted for container

## Troubleshooting

### VHS not found
```bash
make install-vhs
```

### Tests fail with "output does not match golden file"
1. Check the diff file: `test/e2e/golden/*_diff.txt`
2. If changes are intentional: `make e2e-visual-update`
3. If changes are bugs: fix the code

### Golden file not found
Run once with `UPDATE_GOLDEN=1` to create initial golden files.

### Docker/Podman not available
Visual tests require Docker or Podman. Install one of them:
```bash
# Fedora/RHEL
sudo dnf install podman

# Ubuntu/Debian
sudo apt install docker.io
```

### Teatest timeout errors
Increase timeout in `WaitForText()` or `WaitFinished()` calls.

## References

- [VHS Documentation](https://github.com/charmbracelet/vhs)
- [Bubble Tea Testing Guide](https://github.com/charmbracelet/bubbletea/tree/master/teatest)
- Internal: `internal/ui/dashboard/dashboard_test.go` for unit test examples
- Internal: `test/e2e/helpers/teatest_extended.go` for helper API
