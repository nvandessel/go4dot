# E2E Testing Infrastructure

This directory contains end-to-end tests for go4dot, including visual TUI testing using VHS.

## Directory Structure

```
test/e2e/
├── helpers/           # Testing utilities
│   └── vhs.go        # VHS wrapper for running tapes and comparing output
├── scenarios/        # E2E test scenarios
│   └── cli_test.go   # CLI output tests
├── tapes/            # VHS tape files (test scripts)
│   └── dashboard_navigation.tape
├── golden/           # Golden files (expected outputs)
│   └── cli_help.txt
├── screenshots/      # Visual outputs (generated by tests)
├── fixtures/         # Test data and configurations
└── README.md         # This file
```

## Prerequisites

### Install VHS

VHS (Video in High Speed) is a tool for creating terminal recordings and screenshots.

```bash
make install-vhs
```

Or manually:
```bash
go install github.com/charmbracelet/vhs@latest
```

For CI/CD environments, VHS also requires:
- `ttyd` (for web-based terminal)
- `ffmpeg` (for video generation, optional for tests)

## Running Tests

### Run all visual E2E tests
```bash
make e2e-visual
```

### Update golden files
When you make intentional changes to output, update the golden files:
```bash
make e2e-visual-update
```

Or with environment variable:
```bash
UPDATE_GOLDEN=1 go test ./test/e2e/scenarios/...
```

### Clean test outputs
```bash
make e2e-clean
```

## Writing VHS Tests

### 1. Create a VHS Tape

Tapes are declarative scripts that control terminal sessions.

```tape
# test/e2e/tapes/example.tape

# Set up terminal
Set Shell bash
Set Width 100
Set Height 30

# Run commands
Type "./bin/g4d --help"
Enter
Sleep 500ms

# Capture output
Output test/e2e/golden/example.txt
Screenshot test/e2e/screenshots/example.png
```

### 2. Create a Test Scenario

```go
// test/e2e/scenarios/example_test.go
package scenarios

import (
    "os"
    "testing"
    "github.com/nvandessel/go4dot/test/e2e/helpers"
)

func TestExample(t *testing.T) {
    updateGolden := os.Getenv("UPDATE_GOLDEN") == "1"

    cfg := helpers.VHSConfig{
        TapePath:     "test/e2e/tapes/example.tape",
        OutputPath:   "test/e2e/golden/example.txt",
        GoldenPath:   "test/e2e/golden/example.txt",
        UpdateGolden: updateGolden,
    }

    if err := helpers.RunVHSTape(t, cfg); err != nil {
        t.Fatalf("VHS test failed: %v", err)
    }
}
```

### 3. Run and Generate Golden Files

First run with UPDATE_GOLDEN=1 to create the baseline:
```bash
make build
UPDATE_GOLDEN=1 go test ./test/e2e/scenarios/ -run TestExample
```

Then verify tests pass:
```bash
go test ./test/e2e/scenarios/ -run TestExample
```

## VHS Commands Reference

### Terminal Setup
- `Set Shell <shell>` - Set shell (bash, zsh, fish)
- `Set Width <pixels>` - Set terminal width
- `Set Height <pixels>` - Set terminal height
- `Set FontSize <size>` - Set font size

### Input
- `Type "text"` - Type text (without pressing Enter)
- `Enter` - Press Enter key
- `Ctrl+C` - Send Ctrl+C
- `Backspace` - Press backspace
- `Up/Down/Left/Right` - Arrow keys

### Output
- `Output <path>` - Save terminal output to file
- `Screenshot <path>` - Take screenshot

### Timing
- `Sleep <duration>` - Wait (e.g., `500ms`, `2s`)

### Environment
- `Set Env <VAR> <value>` - Set environment variable

## Testing Philosophy

### Golden Files
- **Golden files** are the expected output for a given test
- Store them in `test/e2e/golden/`
- Update them when making intentional changes
- Never commit accidental changes

### Visual Testing
- Screenshots are stored in `test/e2e/screenshots/`
- Use for manual visual verification
- VHS generates high-quality terminal screenshots
- Consider gitignoring screenshots if they're regenerated frequently

### Test Fixtures
- Store test data in `test/e2e/fixtures/`
- Include minimal `.go4dot.yaml` files for testing
- Create isolated environments (temporary HOME dirs)

## CI/CD Integration

In GitHub Actions, install VHS dependencies:

```yaml
- name: Install VHS
  run: |
    go install github.com/charmbracelet/vhs@latest
    # For Ubuntu/Debian
    sudo apt-get install -y ttyd ffmpeg
```

Then run tests:
```yaml
- name: Run E2E Visual Tests
  run: make e2e-visual
```

## Troubleshooting

### VHS not found
```
make install-vhs
```

### Tests fail with "output does not match golden file"
1. Check the diff file: `test/e2e/golden/*_diff.txt`
2. If changes are intentional: `make e2e-visual-update`
3. If changes are bugs: fix the code

### Golden file not found
Run once with `UPDATE_GOLDEN=1` to create initial golden files.

## Future Enhancements

- **Extended teatest helpers** - Programmatic TUI testing (Phase 2)
- **Test orchestrator** - Go CLI to coordinate all test types (Phase 4)
- **Docker platform testing** - Test on multiple distros (Phase 6)
- **Autonomous validation script** - Single command for complete validation (Phase 5)

## References

- [VHS Documentation](https://github.com/charmbracelet/vhs)
- [Bubble Tea Testing Guide](https://github.com/charmbracelet/bubbletea/tree/master/teatest)
- Project plan: `/home/nvandessel/.claude/plans/steady-hugging-moon.md`
