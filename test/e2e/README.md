# E2E Testing Infrastructure

This directory contains end-to-end tests for go4dot, including visual TUI testing using VHS.

## Directory Structure

```text
test/e2e/
├── helpers/           # Testing utilities
│   └── vhs.go        # VHS wrapper for running tapes and comparing output
├── scenarios/        # E2E test scenarios
│   └── cli_test.go   # CLI output tests
├── tapes/            # VHS tape files (test scripts)
│   └── cli_help.tape
├── golden/           # Golden files (expected outputs)
│   └── cli_help.txt
├── outputs/          # Temporary test outputs (gitignored)
├── screenshots/      # Visual outputs (generated by tests)
├── fixtures/         # Test data and configurations
└── README.md         # This file
```

## Prerequisites

### Install VHS

VHS (Video in High Speed) is a tool for creating terminal recordings and screenshots.

```bash
make install-vhs
```

Or manually:
```bash
go install github.com/charmbracelet/vhs@latest
```

For CI/CD environments, VHS also requires:
- `ttyd` (for web-based terminal)
- `ffmpeg` (for video generation, optional for tests)

## Running Tests

### Run all visual E2E tests
```bash
make e2e-visual
```

### Update golden files
When you make intentional changes to output, update the golden files:
```bash
make e2e-visual-update
```

Or with environment variable:
```bash
UPDATE_GOLDEN=1 go test ./test/e2e/scenarios/...
```

### Clean test outputs
```bash
make e2e-clean
```

## Writing VHS Tests

### 1. Create a VHS Tape

Tapes are declarative scripts that control terminal sessions.

```tape
# test/e2e/tapes/example.tape

# Set up terminal
Set Shell bash
Set Width 1200
Set Height 800

# Run commands
Type "./bin/g4d --help"
Enter
Sleep 1s

# Capture output to temporary location (not golden file directly)
Output test/e2e/outputs/example.txt
```

### 2. Create a Test Scenario

Use table-driven test pattern for consistency with project guidelines:

```go
//go:build e2e

// test/e2e/scenarios/example_test.go
package scenarios

import (
    "os"
    "path/filepath"
    "testing"
    "github.com/nvandessel/go4dot/test/e2e/helpers"
)

func TestExample(t *testing.T) {
    tests := []struct {
        name       string
        tapePath   string
        outputPath string
        goldenPath string
    }{
        {
            name:       "example output",
            tapePath:   "test/e2e/tapes/example.tape",
            outputPath: "test/e2e/outputs/example.txt",  // Temporary output
            goldenPath: "test/e2e/golden/example.txt",   // Expected output
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            updateGolden := os.Getenv("UPDATE_GOLDEN") == "1"
            projectRoot := getProjectRoot(t)

            cfg := helpers.VHSConfig{
                TapePath:     filepath.Join(projectRoot, tt.tapePath),
                OutputPath:   filepath.Join(projectRoot, tt.outputPath),
                GoldenPath:   filepath.Join(projectRoot, tt.goldenPath),
                UpdateGolden: updateGolden,
            }

            if err := helpers.RunVHSTape(t, cfg); err != nil {
                t.Fatalf("VHS test failed: %v", err)
            }

            // Cleanup temporary outputs
            t.Cleanup(func() {
                if !updateGolden {
                    helpers.CleanupVHSOutputs(
                        filepath.Join(projectRoot, tt.outputPath),
                    )
                }
            })
        })
    }
}
```

**Note:** For TUI component unit tests (non-E2E), use the `teatest` framework as documented in AGENTS.md.

### 3. Run and Generate Golden Files

First run with UPDATE_GOLDEN=1 to create the baseline:
```bash
make build
UPDATE_GOLDEN=1 go test ./test/e2e/scenarios/ -run TestExample
```

Then verify tests pass:
```bash
go test ./test/e2e/scenarios/ -run TestExample
```

## VHS Commands Reference

### Terminal Setup
- `Set Shell <shell>` - Set shell (bash, zsh, fish)
- `Set Width <pixels>` - Set terminal width
- `Set Height <pixels>` - Set terminal height
- `Set FontSize <size>` - Set font size

### Input
- `Type "text"` - Type text (without pressing Enter)
- `Enter` - Press Enter key
- `Ctrl+C` - Send Ctrl+C
- `Backspace` - Press backspace
- `Up/Down/Left/Right` - Arrow keys

### Output
- `Output <path>` - Save terminal output to file
- `Screenshot <path>` - Take screenshot

### Timing
- `Sleep <duration>` - Wait (e.g., `500ms`, `2s`)

### Environment
- `Set Env <VAR> <value>` - Set environment variable

## Testing Philosophy

### Golden Files
- **Golden files** are the expected output for a given test
- Store them in `test/e2e/golden/`
- Update them when making intentional changes
- Never commit accidental changes

### Visual Testing
- Screenshots are stored in `test/e2e/screenshots/`
- Use for manual visual verification
- VHS generates high-quality terminal screenshots
- Consider gitignoring screenshots if they're regenerated frequently

### Test Fixtures
- Store test data in `test/e2e/fixtures/`
- Include minimal `.go4dot.yaml` files for testing
- Create isolated environments (temporary HOME dirs)

## Safety Considerations

### Phase 1 (Current) - CLI Help Tests ✅
- **Safe:** Only tests `--help` output
- **No system modifications:** Read-only operations

### Phase 2-3 (Planned) - Interactive Tests ⚠️
When adding tests for operations like `install`, `sync`, or dashboard interactions:

**Safety requirements:**
- Use temporary HOME directories in VHS tapes (`Set Env HOME /tmp/g4d-e2e-test`)
- Use test fixtures from `test/e2e/fixtures/` (not real dotfiles)
- Consider safety gates or skip flags for destructive operations
- Document any tests that might affect the host system

**Example safe tape setup:**
```tape
# Isolate from real system
Set Env HOME /tmp/g4d-e2e-test
Set Env XDG_CONFIG_HOME /tmp/g4d-e2e-test/.config

# Use test fixtures
Type "cd test/e2e/fixtures/minimal"
Enter
Type "./bin/g4d install"
Enter
```

### Phase 6 (Future) - Full Isolation
- Docker-based E2E tests provide complete isolation
- Cannot affect host system
- Safe for testing destructive operations

## CI/CD Integration

In GitHub Actions, install VHS dependencies:

```yaml
- name: Install VHS
  run: |
    go install github.com/charmbracelet/vhs@latest
    # For Ubuntu/Debian
    sudo apt-get install -y ttyd ffmpeg
```

Then run tests:
```yaml
- name: Run E2E Visual Tests
  run: make e2e-visual
```

## Troubleshooting

### VHS not found

```bash
make install-vhs
```

### Tests fail with "output does not match golden file"
1. Check the diff file: `test/e2e/golden/*_diff.txt`
2. If changes are intentional: `make e2e-visual-update`
3. If changes are bugs: fix the code

### Golden file not found
Run once with `UPDATE_GOLDEN=1` to create initial golden files.

## Future Enhancements

- **Extended teatest helpers** - Programmatic TUI testing (Phase 2)
- **Test orchestrator** - Go CLI to coordinate all test types (Phase 4)
- **Docker platform testing** - Test on multiple distros (Phase 6)
- **Autonomous validation script** - Single command for complete validation (Phase 5)

## References

- [VHS Documentation](https://github.com/charmbracelet/vhs)
- [Bubble Tea Testing Guide](https://github.com/charmbracelet/bubbletea/tree/master/teatest)
- E2E Testing Infrastructure Epic: See project beads for go4dot-bqt
